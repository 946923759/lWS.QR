<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <link rel="stylesheet" type="text/css" href="common.css">

    <script type="text/javascript" src="qrcodegen.min.js"></script>

    <script type="text/javascript">
    // TODO: remove debug
    console.log('start head script');
    var welcome = 'Loading...';
    function redrawQR() {
      var text = document.getElementById('qrtext').value;
      var qrarea = document.getElementById('qrcode');
      if (text.length == 0) {
        qrarea.style.width = '90%';
        qrarea.style.margin = 'auto';
        qrarea.innerHTML = welcome;
        return;
      } else {
        qrarea.style.width = '5%';
        qrarea.style.margin = '0.1em auto 0.1em';
        qrarea.innerHTML = "<canvas id=\"qrcode-canvas\" style=\"padding:1em; background-color:#E8E8E8\" />"
      }
      var segs = qrcodegen.QrSegment.makeSegments(text);
      var canvas = document.getElementById("qrcode-canvas");
      var ecl = qrcodegen.QrCode.Ecc.LOW;
      switch(document.getElementById('corr').value) {
        case 'L':
          ecl = qrcodegen.QrCode.Ecc.LOW;
          break;
        case 'M':
          ecl = qrcodegen.QrCode.Ecc.MEDIUM;
          break;
        case 'Q':
          ecl = qrcodegen.QrCode.Ecc.QUARTILE;
          break;
        case 'H':
          ecl = qrcodegen.QrCode.Ecc.HIGH;
          break;
        default:
          ecl = qrcodegen.QrCode.Ecc.LOW;
      }
      var mask = parseInt(document.getElementById("mask").value, 10);
      var minVer = parseInt(document.getElementById("min_version").value, 10);
      if ( minVer <= 0 || scale > 40 ) {
          minVer = 1;
          document.getElementById("minVer").value = 1;
      }
      var boostEcc = document.getElementById("boost_ecc").checked;
      var qr = qrcodegen.QrCode.encodeSegments(segs, ecl, minVer, 40, mask, boostEcc);
      var scale = parseInt(document.getElementById("module_size").value, 10);
      if ( scale <= 1 || scale > 32 ) {
          scale = 4;
          document.getElementById("module_size").value = 4;
      }

      qr.drawCanvas(scale, 4, canvas);
      canvas.style.removeProperty("display");

      // Returns a string to describe the given list of segments.
      function describeSegments(segs) {
        if (segs.length == 0)
            return "none";
        else if (segs.length == 1) {
            var mode = segs[0].mode;
            var Mode = qrcodegen.QrSegment.Mode;
            if (mode == Mode.NUMERIC     )  return "numeric";
            if (mode == Mode.ALPHANUMERIC)  return "alphanumeric";
            if (mode == Mode.BYTE        )  return "byte";
            if (mode == Mode.KANJI       )  return "kanji";
            return "unknown";
        } else
            return "multiple";
      }

      // Returns the number of Unicode code points in the given UTF-16 string.
      function countUnicodeChars(str) {
        var result = 0;
        for (var i = 0; i < str.length; i++, result++) {
            var c = str.charCodeAt(i);
            if (c < 0xD800 || c >= 0xE000)
                continue;
            else if (0xD800 <= c && c < 0xDC00) {  // High surrogate
                i++;
                var d = str.charCodeAt(i);
                if (0xDC00 <= d && d < 0xE000)  // Low surrogate
                    continue;
            }
            throw "Invalid UTF-16 string";
        }
        return result;
      }

      // Show the QR Code symbol's statistics as a string
      var stats = "Statistics: \n";
      stats += "QR Code version: " + qr.version + ", ";
      stats += "mask pattern: " + qr.mask + "\n";
      stats += "character count: " + countUnicodeChars(text) + ", ";
      stats += "encoding mode: " + describeSegments(segs) + "\n";
      stats += "error correction level: " + "LMQH".charAt(qr.errorCorrectionLevel.ordinal) + ", ";
      stats += "data bits: " + qrcodegen.QrSegment.getTotalBits(segs, qr.version) + ".";
      var elem = document.getElementById("statistics-output");
      while (elem.firstChild != null)
        elem.removeChild(elem.firstChild);
      elem.appendChild(document.createTextNode(stats));
    }
     // TODO: remove debug
    console.log('finish head script');
    </script>

</head>
<body>

    <!-- Main tab -->
<div id="Main" class="tab" style="display:block">
<div class="frame">
<div
  id="qrcode"
  style="
    display:table;
    width:5%;
    margin: 0.1em auto 0.1em;
  "
>

    <canvas id="qrcode-canvas" style="padding:1em; background-color:#E8E8E8" />
</div>
</div>

<div
  class="frame"
  id="unattended"
  style="
    padding:1em;
    display:none;
  "
>
  <span
    id="text"
    style="
      color:#0f0f0f;
      font-family:monospace;
      font-weight:bold;
      word-wrap: break-word;
      font-size:1.3em;
    "
  />
</div>

<div class="frame" id="interactive" style="display:none">
<form>
  <br />
  <textarea
      style="
          width:98%;
          margin: -1.3em 0 0.5em 0;
          border-radius: 7px;
      "
      placeholder="Enter text to encode here..."
      rows="2"
      id="qrtext"
      onkeyup="
        redrawQR();
      "
  ></textarea>
  <br/>
  <button
      style="width:49.25%"
      type="button"
      onClick="redrawQR();"
       console.log('encode button');     
  >
Encode
  </button>
  <button
      style="width:49.25%"
      type="button"
      onClick="
          document.getElementById('qrtext').value = '';
          redrawQR();
      "
  >
Clear
  </button>
    <div class="frame">
      <p id="statistics-output" style="white-space:pre"></p>
    </div>
    <div class="frame">
    <table align="center">
      <tr>
        <td>
Module size [2px - 32px]
        </td>
        <td align="right">
  <input type="number"  step="1" id="module_size" min="2" max="32" size="2" value="6" onChange="redrawQR();" style="width:3em;" />
        </td>
     </tr>
     <tr>
       <td colspan="2">
         <hr style="margin-top:0.1em;margin-bottom:0.1em"/>
       </td>
     </tr>
     <tr>
       <td>
Error correction level
       </td>
       <td align="right">
         <select name="correction" id="corr" value="L" onchange="redrawQR();">
           <option value="L">L (7%)</option>
           <option value="M">M (15%)</option>
           <option value="Q">Q (25%)</option>
           <option value="H">H (30%)</option>
         </select>
       </td>
     </tr>
     <tr>
       <td colspan="2">
         <input type="checkbox" checked="checked" id="boost_ecc" onchange="redrawQR();"><label for="boost-ecc-input">Increase <abbr title="error-correcting code">ECC</abbr> level within same version</label>
       </td>
     <tr>
       <td colspan="2">
         <hr style="margin-top:0.1em;margin-bottom:0.1em"/>
       </td>
     </tr>
     <tr>
       <td>
Mask
       </td>
       <td align="right">
         <select name="mask" id="mask" value="-1" onchange="redrawQR();">
           <option value="-1">Auto</option>
           <option value="0">0</option>
           <option value="1">1</option>
           <option value="2">2</option>
           <option value="3">3</option>
           <option value="4">4</option>
           <option value="5">5</option>
           <option value="6">6</option>
           <option value="7">7</option>
         </select>
       </td>
     </tr>
     <tr>
       <td colspan="2">
         <hr style="margin-top:0.1em;margin-bottom:0.1em"/>
       </td>
     </tr>
     <tr>
       <td>
Min version [1-40]
       </td>
       <td align="right">
  <input type="number"  step="1" id="min_version" min="1" max="40" size="2" value="1" onChange="redrawQR();" style="width:3em;" />
       </td>
    </tr>
 </table>
 </div>
</form>
</div>

  <script type="text/javascript">
    // TODO: remove debug
    document.getElementById('interactive').style.display = 'block';

    redrawQR();

  </script>

        </div>

</body>

</html>
